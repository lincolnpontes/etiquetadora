<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    
    <link rel="manifest" href="manifest.json">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1565C0">
    <title>Etiquetadora</title>
    
    <link rel="icon" sizes="192x192" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }
    </script>

    <style>
        /* ESTILOS VISUAIS DO APP (Mesmo de antes) */
        body { font-family: Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 500px; background-color: #ffffff; min-height: 100vh; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
        .header { background-color: #1565C0; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .header-title { flex: 1; font-size: 18px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-actions button { background: none; border: none; color: white; font-size: 24px; cursor: pointer; margin-left: 10px; }
        .operator-bar { background-color: #1976D2; color: white; padding: 8px 15px; display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .operator-bar select { flex: 1; padding: 8px; border-radius: 4px; border: none; font-weight: bold; }
        .search-box { background-color: #E3F2FD; padding: 15px; display: flex; gap: 10px; }
        .search-box input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        .search-box button { background-color: #1976D2; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .filters { padding: 10px 15px; display: flex; gap: 10px; overflow-x: auto; white-space: nowrap; border-bottom: 1px solid #eee; }
        .chip { background-color: #e0e0e0; color: #333; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: bold; border: 2px solid transparent; }
        .chip.active { border: 2px solid #333; opacity: 0.9; }
        .list { padding: 0; margin: 0; list-style: none; padding-bottom: 20px; }
        .item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .item:hover { background-color: #f9f9f9; }
        .item-avatar { background-color: #BBDEFB; color: #1565C0; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; }
        .item-info { flex: 1; }
        .item-title { font-weight: bold; font-size: 18px; margin-bottom: 4px; }
        .item-subtitle { color: #666; font-size: 14px; }
        .print-icon { color: #1976D2; font-size: 24px; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #333; border-bottom: 2px solid #1976D2; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #555; font-weight: bold; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        .form-group input[type="color"] { height: 45px; padding: 2px; cursor: pointer; width: 100%; }
        .qtd-control { display: flex; align-items: center; gap: 15px; }
        .qtd-btn { background: #e0e0e0; border: none; width: 35px; height: 35px; border-radius: 50%; font-size: 20px; cursor: pointer; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: #eee; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; color: #333; font-weight: bold; }
        .btn-action { background: #1976D2; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-danger { background: #d32f2f; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-outline { background: #E3F2FD; color: #1976D2; border: 1px solid #1976D2; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px; display: flex; align-items: center; justify-content: flex-start; gap: 15px; }
        .btn-outline-icon { font-size: 28px; }
        .gerenciar-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .gerenciar-info { flex: 1; font-size: 14px; }
        .gerenciar-actions button { background: none; border: none; cursor: pointer; font-size: 20px; margin-left: 10px; }
        .color-preview { display: inline-block; padding: 2px 8px; border-radius: 12px; margin-right: 5px; vertical-align: middle; border: 1px solid #ccc; font-weight: bold; font-size: 12px; }

        /* ESTILOS DA ETIQUETA VISUAL (O GABARITO) */
        #area-impressao-visual {
            position: fixed; top: -9999px; left: 0; /* Esconde da tela do celular */
            width: 384px; /* Largura padr√£o para 50mm/58mm (203dpi) */
            background: white;
            color: black;
            font-family: 'Helvetica', 'Arial', sans-serif; /* Fontes bonitas */
            box-sizing: border-box;
            /* BORDA GROSSA EXTRENA */
            border: 4px solid black; 
            /* MARGEM DE SEGURAN√áA DE 0,2cm (aprox 12px) */
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .etiqueta-header { text-align: center; font-weight: 900; font-size: 24px; text-transform: uppercase; margin-bottom: 10px; line-height: 1.1; }
        /* LINHAS GROSSAS INTERNAS */
        .etiqueta-divider { border-top: 3px solid black; margin: 10px 0; }
        .etiqueta-body { font-size: 18px; line-height: 1.4; }
        .etiqueta-row { display: flex; margin-bottom: 5px; }
        .etiqueta-label { font-weight: bold; margin-right: 8px; }
        .etiqueta-val-destaque { font-size: 20px; font-weight: 900; }
        .etiqueta-footer { text-align: center; font-size: 16px; font-weight: bold; }
    </style>
</head>
<body>

<div id="area-impressao-visual">
    <div class="etiqueta-header" id="viz-nome-produto">NOME DO PRODUTO</div>
    <div class="etiqueta-divider"></div>
    <div class="etiqueta-body">
        <div class="etiqueta-row">
            <span class="etiqueta-label">Manipulado:</span>
            <span id="viz-data-man">00/00/0000 - 00:00</span>
        </div>
        <div class="etiqueta-row">
            <span class="etiqueta-label">Peso:</span>
            <span id="viz-peso">0 g</span>
        </div>
        <div class="etiqueta-row" style="align-items: center; margin-top: 8px;">
            <span class="etiqueta-label" style="font-size: 20px;">VALIDADE:</span>
            <span class="etiqueta-val-destaque" id="viz-data-val">00/00/0000</span>
        </div>
    </div>
    <div class="etiqueta-divider"></div>
    <div class="etiqueta-footer">
        <div id="viz-estabelecimento">Restaurante</div>
        <div style="font-weight: normal; font-size: 14px; margin-top: 5px;">Operador(a): <span id="viz-operador">Nome</span></div>
    </div>
</div>

<div class="app-container">
    <div class="header">
        <div class="header-title" id="appTitle">Etiquetadora</div>
        <div class="header-actions">
            <button onclick="abrirLoginAdmin()" title="Painel e Configura√ß√µes">‚öôÔ∏è</button>
        </div>
    </div>
    
    <div class="operator-bar">
        <span>Operador(a):</span>
        <select id="seletorOperador" onchange="verificarTrocaOperador(this)"></select>
    </div>

    <div class="search-box">
        <input type="number" id="buscaCodigo" placeholder="Digitar C√≥digo (Ex: 2)" inputmode="numeric" pattern="[0-9]*">
        <button onclick="buscarPorCodigo()">Buscar</button>
    </div>

    <div class="filters" id="containerFiltros"></div>
    <ul class="list" id="listaProdutos"></ul>
</div>

<div class="modal-overlay" id="modalLoginAdmin">
    <div class="modal">
        <div class="modal-title">Acesso Restrito</div>
        <div class="form-group">
            <label>Senha do Administrador:</label>
            <input type="password" id="senhaAdmin" placeholder="Digite a senha" inputmode="numeric" pattern="[0-9]*">
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="fecharModal('modalLoginAdmin')">Cancelar</button>
            <button class="btn-action" onclick="validarSenhaAdmin()">Entrar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalPainelUnificado">
    <div class="modal">
        <div style="text-align: center; color: #666; font-size: 13px; font-weight: bold; margin-bottom: 5px;">
            Etiquetadora - v1.3 (Imagem)
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1976D2; padding-bottom: 10px; margin-bottom: 20px;">
            <h2 id="displayEstabelecimento" style="margin: 0; font-size: 18px; color: #333;"></h2>
            <button onclick="editarEstabelecimento()" title="Editar Nome" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #1976D2;">‚úèÔ∏è</button>
        </div>

        <h3 style="font-size: 16px; color: #555; margin-bottom: 10px;">Painel de Gest√£o</h3>
        <button class="btn-outline" onclick="abrirGerenciar('produtos')">
            <span class="btn-outline-icon">üì¶</span> Gerenciar Produtos
        </button>
        <button class="btn-outline" onclick="abrirGerenciar('categorias')">
            <span class="btn-outline-icon">üè∑Ô∏è</span> Gerenciar Categorias
        </button>
        <button class="btn-outline" onclick="abrirGerenciar('operadores')">
            <span class="btn-outline-icon">üë•</span> Gerenciar Operadores(as)
        </button>

        <h3 style="font-size: 16px; color: #555; margin-top: 25px; margin-bottom: 10px;">Configura√ß√µes do Sistema</h3>
        <div class="form-group">
            <label>Destino da Impress√£o:</label>
            <select id="configModo" onchange="salvarModoRapido()">
                <option value="pdf">Visualizar no Ecr√£ (Gerar PDF)</option>
                <option value="rawbt">App Externo (Imprimir via RawBT)</option>
            </select>
        </div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="btn-outline" style="margin: 0; flex: 1; justify-content: center;" onclick="exportarBanco()">‚¨áÔ∏è Exportar</button>
            <button class="btn-outline" style="margin: 0; flex: 1; justify-content: center;" onclick="document.getElementById('fileImport').click()">‚¨ÜÔ∏è Importar</button>
            <input type="file" id="fileImport" style="display: none;" accept=".json,.txt" onchange="importarBanco(event)">
        </div>
        <button class="btn-danger" onclick="restaurarPadroes()">Restaurar Sistema (Apagar Tudo)</button>

        <div class="modal-actions">
            <button class="btn-cancel" onclick="fecharModal('modalPainelUnificado')">Fechar Painel</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalSenhaOperador">
    <div class="modal">
        <div class="modal-title">Confirma√ß√£o de Identidade</div>
        <p style="margin-top:0; color:#555;">Este operador(a) exige senha.</p>
        <input type="hidden" id="operadorAlvo">
        <div class="form-group">
            <label>Senha:</label>
            <input type="password" id="senhaTrocaOperador" inputmode="numeric" pattern="[0-9]*">
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="cancelarTrocaOperador()">Cancelar</button>
            <button class="btn-action" onclick="confirmarTrocaOperador()">Confirmar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalListagem">
    <div class="modal">
        <div class="modal-title" id="tituloListagem">Gerenciar</div>
        <button class="btn-action" id="btnNovoListagem" style="width: 100%; margin-bottom: 15px;">+ Novo</button>
        <div id="conteudoListagem" style="max-height: 50vh; overflow-y: auto; padding-right: 5px;"></div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="voltarPainelUnificado()">Voltar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalFormProduto">
    <div class="modal">
        <div class="modal-title">Produto</div>
        <input type="hidden" id="prodCodigoOriginal">
        <div class="form-group">
            <label>C√≥digo Num√©rico:</label>
            <input type="number" id="prodCodigo">
        </div>
        <div class="form-group">
            <label>Nome do Produto:</label>
            <input type="text" id="prodNome">
        </div>
        <div class="form-group">
            <label>Categoria:</label>
            <select id="prodCategoria"></select>
        </div>
        <div class="form-group">
            <label>Validade em Dias:</label>
            <input type="number" id="prodValidade">
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="fecharModal('modalFormProduto'); abrirGerenciar('produtos')">Cancelar</button>
            <button class="btn-action" onclick="salvarProduto()">Salvar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalFormCategoria">
    <div class="modal">
        <div class="modal-title">Categoria</div>
        <input type="hidden" id="catNomeOriginal">
        <div class="form-group">
            <label>Nome da Categoria:</label>
            <input type="text" id="catNome">
        </div>
        <div style="display: flex; gap: 10px;">
            <div class="form-group" style="flex: 1;">
                <label>Cor do Fundo:</label>
                <input type="color" id="catCor" value="#1976D2">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>Cor do Texto:</label>
                <input type="color" id="catCorTexto" value="#ffffff">
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="fecharModal('modalFormCategoria'); abrirGerenciar('categorias')">Cancelar</button>
            <button class="btn-action" onclick="salvarCategoria()">Salvar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalFormOperador">
    <div class="modal">
        <div class="modal-title">Operador(a)</div>
        <input type="hidden" id="opNomeOriginal">
        <div class="form-group">
            <label>Nome do Operador(a):</label>
            <input type="text" id="opNome">
        </div>
        <div class="form-group">
            <label>Senha (Deixe em branco para sem senha):</label>
            <input type="text" id="opSenha" placeholder="Opcional" inputmode="numeric" pattern="[0-9]*">
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="fecharModal('modalFormOperador'); abrirGerenciar('operadores')">Cancelar</button>
            <button class="btn-action" onclick="salvarOperador()">Salvar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalImprimir">
    <div class="modal">
        <div class="modal-title" id="imprimirNomeProduto">Produto</div>
        <input type="hidden" id="imprimirCodigoProduto">
        <div class="form-group">
            <label>Quantidade de Etiquetas:</label>
            <div class="qtd-control">
                <button class="qtd-btn" onclick="mudarQtd(-1)">-</button>
                <span id="imprimirQtd" style="font-size: 20px; font-weight: bold;">1</span>
                <button class="qtd-btn" onclick="mudarQtd(1)">+</button>
            </div>
        </div>
        <div class="form-group">
            <label>Peso em gramas (Opcional):</label>
            <input type="number" id="imprimirPeso" placeholder="0 g">
        </div>
        <div class="form-group">
            <label>Data de Validade Final:</label>
            <input type="date" id="imprimirValidade">
        </div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="fecharModal('modalImprimir')">Cancelar</button>
            <button class="btn-action" onclick="processarImpressao()">üñ®Ô∏è IMPRIMIR</button>
        </div>
    </div>
</div>

<script>
    let db = carregarBanco();
    let categoriaAtual = null;
    let quantidadeAtual = 1;
    let operadorAnteriorSelect = null;

    function carregarBanco() {
        let defaultDB = {
            produtos: [
                { codigo: 1, nome: "Hamb√∫rguer Bovino", categoria: "Carnes", validadeDias: 5 },
                { codigo: 2, nome: "Lingui√ßa Artesanal", categoria: "Embutidos", validadeDias: 15 }
            ],
            categorias: [
                { nome: "Carnes", cor: "#ffcccc", corTexto: "#000000" },
                { nome: "Embutidos", cor: "#fff0b3", corTexto: "#000000" }
            ],
            operadores: [
                { nome: "Cozinha 1", senha: "" }
            ],
            configs: { 
                modo: "pdf", 
                estabelecimento: "Restaurante"
            }
        };

        let local = JSON.parse(localStorage.getItem('etiquetadora_db'));
        return local || defaultDB;
    }

    function salvarBancoLocal(dados = db) {
        localStorage.setItem('etiquetadora_db', JSON.stringify(dados));
    }

    function iniciar() {
        if(!db.configs.estabelecimento) db.configs.estabelecimento = "Nome do Estabelecimento";
        
        atualizarTituloAplicativo();
        renderizarOperadores();
        renderizarFiltros();
        renderizarLista();
        
        document.getElementById('senhaAdmin').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') validarSenhaAdmin();
        });
        
        document.getElementById('senhaTrocaOperador').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') confirmarTrocaOperador();
        });
        
        document.getElementById('buscaCodigo').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') buscarPorCodigo();
        });
    }

    function atualizarTituloAplicativo() {
        document.getElementById('appTitle').innerText = db.configs.estabelecimento;
    }

    function fecharModal(id) { document.getElementById(id).style.display = 'none'; }

    function abrirLoginAdmin() {
        document.getElementById('senhaAdmin').value = '';
        document.getElementById('modalLoginAdmin').style.display = 'flex';
        setTimeout(function() {
            document.getElementById('senhaAdmin').focus();
        }, 100);
    }

    function validarSenhaAdmin() {
        if(document.getElementById('senhaAdmin').value === "1999") {
            fecharModal('modalLoginAdmin');
            document.getElementById('displayEstabelecimento').innerText = db.configs.estabelecimento;
            document.getElementById('configModo').value = db.configs.modo;
            document.getElementById('modalPainelUnificado').style.display = 'flex';
        } else {
            alert("Senha incorreta!");
            document.getElementById('senhaAdmin').value = '';
            document.getElementById('senhaAdmin').focus();
        }
    }

    function voltarPainelUnificado() {
        fecharModal('modalListagem');
        document.getElementById('modalPainelUnificado').style.display = 'flex';
    }

    function editarEstabelecimento() {
        let novoNome = prompt("Digite o nome do estabelecimento:", db.configs.estabelecimento);
        if(novoNome && novoNome.trim() !== "") {
            db.configs.estabelecimento = novoNome.trim();
            document.getElementById('displayEstabelecimento').innerText = db.configs.estabelecimento;
            atualizarTituloAplicativo();
            salvarBancoLocal();
        }
    }

    function salvarModoRapido() {
        db.configs.modo = document.getElementById('configModo').value;
        salvarBancoLocal();
    }

    function restaurarPadroes() {
        let senhaDigitada = prompt("A√á√ÉO PERIGOSA! Digite a senha de administrador para poder continuar:");
        
        if (senhaDigitada === "1999") {
            if(confirm("Tem certeza absoluta? Isso apagar√° todos os produtos e categorias cadastradas.")) {
                localStorage.removeItem('etiquetadora_db');
                location.reload();
            }
        } else if (senhaDigitada !== null) {
            alert("Senha incorreta! Restaura√ß√£o cancelada.");
        }
    }

    async function exportarBanco() {
        const dataStr = JSON.stringify(db);
        const fileName = `backup_etiquetadora_${new Date().getTime()}.txt`; 
        const blob = new Blob([dataStr], { type: "text/plain" });
        
        if (navigator.canShare) {
            try {
                const file = new File([blob], fileName, { type: "text/plain" });
                if (navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'Backup da Etiquetadora',
                        text: 'Arquivo de backup do sistema.'
                    });
                    return; 
                }
            } catch (err) {
                console.log("Compartilhamento nativo falhou. Tentando download.");
            }
        }
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(url);
    }

    function importarBanco(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const novoDB = JSON.parse(e.target.result);
                if(novoDB.produtos && novoDB.categorias && novoDB.operadores) {
                    db = novoDB;
                    salvarBancoLocal();
                    alert("Banco de dados restaurado com sucesso!");
                    location.reload();
                } else { alert("Arquivo inv√°lido."); }
            } catch (err) { alert("Erro ao ler o arquivo."); }
        };
        reader.readAsText(file);
    }

    function renderizarOperadores() {
        const seletor = document.getElementById('seletorOperador');
        seletor.innerHTML = '';
        db.operadores.forEach(op => { seletor.innerHTML += `<option value="${op.nome}">${op.nome}</option>`; });
        
        const ultimoOperador = localStorage.getItem('etiquetadora_operadorAtual');
        if(ultimoOperador && db.operadores.find(o => o.nome === ultimoOperador)) {
            seletor.value = ultimoOperador;
            operadorAnteriorSelect = ultimoOperador;
        } else if (db.operadores.length > 0) {
            operadorAnteriorSelect = db.operadores[0].nome;
        }
    }

    function verificarTrocaOperador(selectElement) {
        const novoNome = selectElement.value;
        const op = db.operadores.find(o => o.nome === novoNome);
        
        if(op && op.senha !== "") {
            document.getElementById('operadorAlvo').value = novoNome;
            document.getElementById('senhaTrocaOperador').value = '';
            document.getElementById('modalSenhaOperador').style.display = 'flex';
            setTimeout(function() {
                document.getElementById('senhaTrocaOperador').focus();
            }, 100);
        } else {
            operadorAnteriorSelect = novoNome;
            localStorage.setItem('etiquetadora_operadorAtual', novoNome);
        }
    }

    function confirmarTrocaOperador() {
        const nomeAlvo = document.getElementById('operadorAlvo').value;
        const senhaDigitada = document.getElementById('senhaTrocaOperador').value;
        const op = db.operadores.find(o => o.nome === nomeAlvo);

        if(op && op.senha === senhaDigitada) {
            operadorAnteriorSelect = nomeAlvo;
            localStorage.setItem('etiquetadora_operadorAtual', nomeAlvo);
            fecharModal('modalSenhaOperador');
        } else { 
            alert("Senha incorreta!");
            document.getElementById('senhaTrocaOperador').value = '';
            document.getElementById('senhaTrocaOperador').focus();
        }
    }

    function cancelarTrocaOperador() {
        document.getElementById('seletorOperador').value = operadorAnteriorSelect;
        fecharModal('modalSenhaOperador');
    }

    function renderizarFiltros() {
        let html = `<div class="chip ${categoriaAtual === null ? 'active' : ''}" style="${categoriaAtual === null ? 'background:#ccc; color:#000;' : ''}" onclick="filtrarCategoria(null)">TODOS</div>`;
        db.categorias.forEach(cat => { 
            const isActive = categoriaAtual === cat.nome;
            const corTxt = cat.corTexto || '#000000';
            html += `<div class="chip ${isActive ? 'active' : ''}" style="background-color: ${cat.cor}; color: ${corTxt};" onclick="filtrarCategoria('${cat.nome}')">${cat.nome}</div>`; 
        });
        document.getElementById('containerFiltros').innerHTML = html;
    }

    function filtrarCategoria(cat) { categoriaAtual = cat; renderizarFiltros(); renderizarLista(); }

    function renderizarLista() {
        const lista = document.getElementById('listaProdutos');
        lista.innerHTML = '';
        let filtrados = categoriaAtual === null ? db.produtos : db.produtos.filter(p => p.categoria === categoriaAtual);
        filtrados.sort((a, b) => a.codigo - b.codigo);
        filtrados.forEach(p => {
            const catObj = db.categorias.find(c => c.nome === p.categoria);
            const cor = catObj ? catObj.cor : '#eee';
            const corTxt = catObj && catObj.corTexto ? catObj.corTexto : '#333';
            lista.innerHTML += `
                <li class="item" onclick="abrirModalImprimir(${p.codigo})">
                    <div class="item-avatar" style="background-color: ${cor}; color: ${corTxt};">${p.codigo}</div>
                    <div class="item-info">
                        <div class="item-title">${p.nome}</div>
                        <div class="item-subtitle">${p.categoria} ‚Ä¢ Validade: ${p.validadeDias} dias</div>
                    </div>
                    <div class="print-icon">üñ®Ô∏è</div>
                </li>
            `;
        });
    }

    function buscarPorCodigo() {
        const cod = parseInt(document.getElementById('buscaCodigo').value);
        if(isNaN(cod)) return;
        const produto = db.produtos.find(p => p.codigo === cod);
        if(produto) { 
            abrirModalImprimir(produto.codigo); 
            document.getElementById('buscaCodigo').value = ''; 
            document.getElementById('buscaCodigo').blur(); 
        } else {
            alert("Produto n√£o encontrado!");
        }
    }

    function abrirGerenciar(tipo) {
        fecharModal('modalPainelUnificado');
        fecharModal('modalFormProduto');
        fecharModal('modalFormCategoria');
        fecharModal('modalFormOperador');
        
        const lista = document.getElementById('conteudoListagem');
        const btnNovo = document.getElementById('btnNovoListagem');
        const titulo = document.getElementById('tituloListagem');
        lista.innerHTML = '';

        if(tipo === 'produtos') {
            titulo.innerText = "Gerenciar Produtos";
            btnNovo.onclick = () => abrirFormProduto(null);
            let ordenados = [...db.produtos].sort((a, b) => a.codigo - b.codigo);
            ordenados.forEach(p => {
                lista.innerHTML += `<div class="gerenciar-item"><div class="gerenciar-info"><strong>${p.codigo} - ${p.nome}</strong><br><span style="color:#666">${p.categoria} | ${p.validadeDias} dias</span></div><div class="gerenciar-actions"><button onclick="abrirFormProduto(${p.codigo})">‚úèÔ∏è</button><button onclick="excluirItem('produtos', ${p.codigo})">üóëÔ∏è</button></div></div>`;
            });
        } else if (tipo === 'categorias') {
            titulo.innerText = "Gerenciar Categorias";
            btnNovo.onclick = () => abrirFormCategoria(null);
            db.categorias.forEach(c => {
                const corTxt = c.corTexto || '#000000';
                lista.innerHTML += `<div class="gerenciar-item"><div class="gerenciar-info"><span class="color-preview" style="background:${c.cor}; color:${corTxt}">${c.nome}</span></div><div class="gerenciar-actions"><button onclick="abrirFormCategoria('${c.nome}')">‚úèÔ∏è</button><button onclick="excluirItem('categorias', '${c.nome}')">üóëÔ∏è</button></div></div>`;
            });
        } else if (tipo === 'operadores') {
            titulo.innerText = "Gerenciar Operadores(as)";
            btnNovo.onclick = () => abrirFormOperador(null);
            db.operadores.forEach(o => {
                let statusSenha = o.senha === "" ? "Sem Senha" : "Com Senha";
                lista.innerHTML += `<div class="gerenciar-item"><div class="gerenciar-info"><strong>${o.nome}</strong><br><span style="color:#666">${statusSenha}</span></div><div class="gerenciar-actions"><button onclick="abrirFormOperador('${o.nome}')">‚úèÔ∏è</button><button onclick="excluirItem('operadores', '${o.nome}')">üóëÔ∏è</button></div></div>`;
            });
        }
        document.getElementById('modalListagem').style.display = 'flex';
    }

    function excluirItem(tipo, id) {
        if(!confirm("Certeza que deseja excluir?")) return;
        if(tipo === 'produtos') db.produtos = db.produtos.filter(i => i.codigo !== id);
        if(tipo === 'categorias') db.categorias = db.categorias.filter(i => i.nome !== id);
        if(tipo === 'operadores') db.operadores = db.operadores.filter(i => i.nome !== id);
        salvarBancoLocal(); iniciar(); abrirGerenciar(tipo);
    }

    function abrirFormProduto(codigoOriginal) {
        fecharModal('modalListagem');
        const combo = document.getElementById('prodCategoria');
        combo.innerHTML = '';
        db.categorias.forEach(c => combo.innerHTML += `<option value="${c.nome}">${c.nome}</option>`);

        if(codigoOriginal) {
            const p = db.produtos.find(x => x.codigo === codigoOriginal);
            document.getElementById('prodCodigoOriginal').value = p.codigo;
            document.getElementById('prodCodigo').value = p.codigo;
            document.getElementById('prodNome').value = p.nome;
            document.getElementById('prodCategoria').value = p.categoria;
            document.getElementById('prodValidade').value = p.validadeDias;
        } else {
            document.getElementById('prodCodigoOriginal').value = '';
            document.getElementById('prodCodigo').value = '';
            document.getElementById('prodNome').value = '';
            document.getElementById('prodValidade').value = '';
        }
        document.getElementById('modalFormProduto').style.display = 'flex';
    }

    function salvarProduto() {
        const codOriginal = document.getElementById('prodCodigoOriginal').value;
        const cod = parseInt(document.getElementById('prodCodigo').value);
        const nome = document.getElementById('prodNome').value.trim();
        const cat = document.getElementById('prodCategoria').value;
        const val = parseInt(document.getElementById('prodValidade').value);

        if(!cod || !nome || !cat || isNaN(val)) return alert("Preencha tudo!");
        if(codOriginal === "" && db.produtos.find(p => p.codigo === cod)) return alert("C√≥digo j√° existe!");
        if(codOriginal !== "" && parseInt(codOriginal) !== cod && db.produtos.find(p => p.codigo === cod)) return alert("C√≥digo j√° existe!");

        let obj = { codigo: cod, nome: nome, categoria: cat, validadeDias: val };
        if(codOriginal !== "") {
            const idx = db.produtos.findIndex(p => p.codigo === parseInt(codOriginal));
            db.produtos[idx] = obj;
        } else { db.produtos.push(obj); }
        salvarBancoLocal(); iniciar(); abrirGerenciar('produtos');
    }

    function abrirFormCategoria(nomeOriginal) {
        fecharModal('modalListagem');
        if(nomeOriginal) {
            const c = db.categorias.find(x => x.nome === nomeOriginal);
            document.getElementById('catNomeOriginal').value = c.nome;
            document.getElementById('catNome').value = c.nome;
            document.getElementById('catCor').value = c.cor;
            document.getElementById('catCorTexto').value = c.corTexto || '#000000';
        } else {
            document.getElementById('catNomeOriginal').value = '';
            document.getElementById('catNome').value = '';
            document.getElementById('catCor').value = '#1976D2';
            document.getElementById('catCorTexto').value = '#ffffff';
        }
        document.getElementById('modalFormCategoria').style.display = 'flex';
    }

    function salvarCategoria() {
        const nomeOrig = document.getElementById('catNomeOriginal').value;
        const nome = document.getElementById('catNome').value.trim();
        const cor = document.getElementById('catCor').value;
        const corTexto = document.getElementById('catCorTexto').value;

        if(!nome) return alert("Preencha o nome!");
        if(nomeOrig === "" && db.categorias.find(c => c.nome.toLowerCase() === nome.toLowerCase())) return alert("Categoria j√° existe!");

        if(nomeOrig !== "") {
            const idx = db.categorias.findIndex(c => c.nome === nomeOrig);
            db.categorias[idx] = { nome, cor, corTexto };
            db.produtos.forEach(p => { if(p.categoria === nomeOrig) p.categoria = nome; });
        } else { db.categorias.push({ nome, cor, corTexto }); }
        salvarBancoLocal(); iniciar(); abrirGerenciar('categorias');
    }

    function abrirFormOperador(nomeOriginal) {
        fecharModal('modalListagem');
        if(nomeOriginal) {
            const o = db.operadores.find(x => x.nome === nomeOriginal);
            document.getElementById('opNomeOriginal').value = o.nome;
            document.getElementById('opNome').value = o.nome;
            document.getElementById('opSenha').value = o.senha;
        } else {
            document.getElementById('opNomeOriginal').value = '';
            document.getElementById('opNome').value = '';
            document.getElementById('opSenha').value = '';
        }
        document.getElementById('modalFormOperador').style.display = 'flex';
    }

    function salvarOperador() {
        const nomeOrig = document.getElementById('opNomeOriginal').value;
        const nome = document.getElementById('opNome').value.trim();
        const senha = document.getElementById('opSenha').value.trim();

        if(!nome) return alert("Preencha o nome!");
        if(nomeOrig === "" && db.operadores.find(o => o.nome.toLowerCase() === nome.toLowerCase())) return alert("Operador(a) j√° existe!");

        if(nomeOrig !== "") {
            const idx = db.operadores.findIndex(o => o.nome === nomeOrig);
            db.operadores[idx] = { nome, senha };
            if(localStorage.getItem('etiquetadora_operadorAtual') === nomeOrig) localStorage.setItem('etiquetadora_operadorAtual', nome);
        } else { db.operadores.push({ nome, senha }); }
        salvarBancoLocal(); iniciar(); abrirGerenciar('operadores');
    }

    function abrirModalImprimir(codigo) {
        const produto = db.produtos.find(p => p.codigo === codigo);
        quantidadeAtual = 1;
        let dataValidade = new Date();
        dataValidade.setDate(dataValidade.getDate() + produto.validadeDias);
        document.getElementById('imprimirCodigoProduto').value = produto.codigo;
        document.getElementById('imprimirNomeProduto').innerText = "Imprimir: " + produto.nome;
        document.getElementById('imprimirQtd').innerText = quantidadeAtual;
        document.getElementById('imprimirPeso').value = '';
        document.getElementById('imprimirValidade').value = dataValidade.toISOString().split('T')[0];
        document.getElementById('modalImprimir').style.display = 'flex';
    }

    function mudarQtd(valor) {
        if(quantidadeAtual + valor > 0) { quantidadeAtual += valor; document.getElementById('imprimirQtd').innerText = quantidadeAtual; }
    }

    function processarImpressao() {
        const codigo = parseInt(document.getElementById('imprimirCodigoProduto').value);
        const produto = db.produtos.find(p => p.codigo === codigo);
        const inputPeso = document.getElementById('imprimirPeso').value.trim();
        const dataValidadeInput = document.getElementById('imprimirValidade').value;
        const operador = document.getElementById('seletorOperador').value;
        const estabelecimento = db.configs.estabelecimento;
        
        const pesoFormatado = inputPeso === "" ? "-" : `${inputPeso} g`;
        const partesData = dataValidadeInput.split('-');
        const dataValidadeBR = `${partesData[2]}/${partesData[1]}/${partesData[0]}`;
        
        const hoje = new Date();
        const dataManipulacaoBR = `${String(hoje.getDate()).padStart(2, '0')}/${String(hoje.getMonth() + 1).padStart(2, '0')}/${hoje.getFullYear()}`;
        const horaBR = `${String(hoje.getHours()).padStart(2, '0')}:${String(hoje.getMinutes()).padStart(2, '0')}`;

        fecharModal('modalImprimir');

        if(db.configs.modo === 'pdf') {
            gerarEtiquetaPDF(produto, pesoFormatado, dataManipulacaoBR, horaBR, dataValidadeBR, quantidadeAtual, operador, estabelecimento);
        } else {
            enviarParaRawBT(produto, pesoFormatado, dataManipulacaoBR, horaBR, dataValidadeBR, quantidadeAtual, operador, estabelecimento);
        }
    }

    function gerarEtiquetaPDF(produto, peso, dataMan, hora, dataVal, qtd, operador, estabelecimento) {
        // Fun√ß√£o simplificada para PDF, focando apenas nos dados, j√° que o foco agora √© a imagem para RawBT
        let printWindow = window.open('', '', 'width=350,height=500');
        let htmlContent = `
            <html><head><style>
                body { font-family: sans-serif; padding: 20px; }
                .etiqueta { border: 2px solid black; padding: 10px; margin-bottom: 20px; width: 300px; }
                h2 { margin: 0 0 10px 0; text-align: center; border-bottom: 2px solid black; padding-bottom: 5px; }
            </style></head><body>
        `;
        for(let i = 0; i < qtd; i++) {
            htmlContent += `
                <div class="etiqueta">
                    <h2>${produto.nome}</h2>
                    <p><b>Manipulado:</b> ${dataMan} - ${hora}</p>
                    <p><b>Peso:</b> ${peso}</p>
                    <p><b>Validade:</b> ${dataVal}</p>
                    <p style="text-align:center; margin-top:10px; border-top: 1px solid black; padding-top:5px;">${estabelecimento} - Op: ${operador}</p>
                </div>
            `;
        }
        htmlContent += `<script>window.onload = function() { window.print(); window.close(); }<\/script></body></html>`;
        printWindow.document.write(htmlContent);
        printWindow.document.close();
    }

    // --- NOVA FUN√á√ÉO DE ENVIO (MODO IMAGEM/CAPRICHO) ---
    function enviarParaRawBT(produto, peso, dataMan, hora, dataVal, qtd, operador, estabelecimento) {
        // 1. Preenche o gabarito invis√≠vel com os dados
        document.getElementById('viz-nome-produto').innerText = produto.nome;
        document.getElementById('viz-data-man').innerText = `${dataMan} - ${hora}`;
        document.getElementById('viz-peso').innerText = peso;
        document.getElementById('viz-data-val').innerText = dataVal;
        document.getElementById('viz-estabelecimento').innerText = estabelecimento;
        document.getElementById('viz-operador').innerText = operador;

        const gabarito = document.getElementById('area-impressao-visual');

        // 2. Chama o fot√≥grafo (html2canvas) para tirar um print do gabarito
        html2canvas(gabarito, { scale: 2 }).then(canvas => {
            // A escala 2 aumenta a qualidade da imagem para ficar n√≠tida na impress√£o
            const imgDataUrl = canvas.toDataURL("image/png");
            // Remove o cabe√ßalho da imagem para sobrar s√≥ o c√≥digo puro
            const base64Raw = imgDataUrl.replace(/^data:image\/(png|jpg);base64,/, "");

            // 3. Monta o comando para o RawBT imprimir a imagem
            const intent = `intent:#Intent;scheme=rawbt;package=ru.a402d.rawbtprinter;S.base64=${base64Raw};end;`;
            
            // Loop para m√∫ltiplas c√≥pias
            for(let i = 0; i < qtd; i++) {
                // Um pequeno delay entre impress√µes para n√£o engasgar o app com imagens pesadas
                setTimeout(() => { window.location.href = intent; }, i * 500);
            }
        });
    }

    iniciar();
</script>

</body>
</html>
